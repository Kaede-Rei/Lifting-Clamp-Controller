# 樱桃番茄采摘系统 - 下位机 (STM32)

[English](./README.md) | [中文](./README_zh.md)

本项目为樱桃番茄自动化采摘系统的下位机控制程序，基于 STM32F103 (Cortex-M3) 开发。
下位机主要负责控制**升降台**的垂直运动与末端**夹爪**的开合动作，通过简单的串口指令与上位机（如树莓派、PC）进行交互。

## 📖 项目简介

该系统设计用于果蔬采摘场景。下位机作为执行机构控制器，接收上位机发送的 ASCII 字符串指令，执行相应的动作控制。

*   **升降台控制**: 支持手动（点动）升降与自动（PID位置闭环）控制。通过继电器驱动电机正反转，并配合光电编码器实现定位。
*   **夹爪控制**: 通过 CAN 总线控制末端执行器的开合角度。
*   **状态管理**: 内置分层有限状态机 (HFSM)，确保系统在不同模式（空闲、移动、故障）间的安全切换。

## 🛠️ 环境配置

*   **硬件平台**: STM32F103 (标准库)
*   **开发环境**: Keil MDK-ARM v5 / VS Code (Embedded IDE 插件)
*   **编译器**: ARMCC (AC5)
*   **编程语言**: C (C99 Standard)

## 📂 代码结构

项目采用分层架构设计，各模块耦合度低：

```text
src/
├── app/                  # 应用层
│   ├── a_fsm.c/.h        # 有限状态机 (主要业务逻辑)
│   └── a_board.c/.h      # 板级初始化 (硬件资源配置)
├── driver/               # 驱动层
│   ├── d_relay.c         # 继电器驱动 (控制升降台电机方向)
│   ├── d_gripper.c       # 夹爪驱动 (CAN通信控制)
│   └── d_encoder.c       # 编码器接口 (位置反馈)
├── service/              # 服务层
│   ├── s_wireless_comms.c # 无线/串口通信协议解析
│   ├── s_pid.c           # PID 位置控制算法
│   └── s_log.c           # 日志调试
└── main.c                # 程序入口
```

## ⚙️ 功能模块说明

### 1. 通信协议 (Communication Protocol)
下位机通过 USART1（波特率 115200）与上位机通信，指令格式为 ASCII 字符串，以 `$` 开头，`#` 结尾。

**命令列表：**

| 模块 | 功能 | 指令格式 | 说明 |
| :--- | :--- | :--- | :--- |
| **升降台** | 上升 | `$LIFT_UP#` | 继电器动作，平台上升 |
| | 下降 | `$LIFT_DOWN#` | 继电器动作，平台下降 |
| | 停止 | `$LIFT_STOP#` | 停止电机 |
| | 设定高度 | `$LIFT_SET:<float>#` | 例如 `$LIFT_SET:150.5#` (单位: mm)，触发 PID 自动运行 |
| **夹爪** | 张开 | `$GRIP_OPEN#` | 夹爪张开至预设角度 |
| | 闭合 | `$GRIP_CLOSE#` | 夹爪闭合至预设角度 |
| | 设定角度 | `$GRIP_SET:<float>#` | 例如 `$GRIP_SET:1.57#` (单位: rad) |

### 2. 有限状态机 (Finite State Machine)
系统状态由 `a_fsm.c` 管理，采用分层设计：

*   **Normal (正常模式)**
    *   **Idle (空闲)**: 系统就绪，等待指令。
    *   **LiftMoving (升降中)**: 接收到 `$LIFT_SET` 指令后进入此状态，此时 PID 算法接管继电器控制，直到到达目标位置。
*   **Error (错误模式)**: 发生硬件故障或异常时进入，系统停机保护。

### 3. 硬件连接

*   **继电器 (Lift Motor)**:
    *   GPIOB Pin 0 (方向 A)
    *   GPIOB Pin 1 (方向 B)
*   **夹爪 (Gripper)**: CAN1 总线
*   **串口 (Wireless)**: USART1 (TX/RX)
